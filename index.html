<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixEd - School Reporting System</title>
    <!-- Use Tailwind CSS for a clean, modern, and responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom modal styles to replace alerts and confirms */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">
    <!-- The main application container -->
    <div id="appContainer" class="bg-white rounded-2xl shadow-xl p-8 sm:p-10 w-full max-w-xl">
        
        <!-- Connection Status Indicator -->
        <div id="connectionStatus" class="absolute top-4 right-4 text-xs font-semibold rounded-full px-3 py-1"></div>

        <!-- Main Menu Screen -->
        <div id="mainMenu" class="transition-opacity duration-300">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2 text-center">Welcome to FixEd!</h1>
            <p class="text-gray-500 mb-8 text-center">What would you like to do today?</p>
            <div class="flex flex-col space-y-4">
                <button onclick="showReportForm()" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                    Submit a Report
                </button>
                <button onclick="showAdminPanel()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                    View Reports
                </button>
            </div>
        </div>

        <!-- Report Submission Form -->
        <div id="reportForm" class="hidden transition-opacity duration-300">
            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-800 mb-6 text-center">Submit a Report</h2>
            <form id="reportFormData" onsubmit="submitReport(event)" class="space-y-4">
                <div>
                    <label for="name" class="block text-gray-700 font-medium mb-1">Name (optional):</label>
                    <input type="text" id="name" placeholder="Enter your name or leave blank for anonymous" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400">
                </div>
                <div>
                    <label for="grade" class="block text-gray-700 font-medium mb-1">Grade:</label>
                    <input type="text" id="grade" placeholder="What grade are you in?" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400">
                </div>
                <div>
                    <label for="location" class="block text-gray-700 font-medium mb-1">Location:</label>
                    <input type="text" id="location" placeholder="Where did this happen? (e.g., Cafeteria)" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400">
                </div>
                <div>
                    <label for="issueType" class="block text-gray-700 font-medium mb-1">Issue Type:</label>
                    <input type="text" id="issueType" placeholder="What type of issue are you reporting?" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400">
                </div>
                <div>
                    <label for="description" class="block text-gray-700 font-medium mb-1">Description:</label>
                    <textarea id="description" placeholder="Please describe what happened in detail" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400"></textarea>
                </div>
                <div>
                    <label for="severity" class="block text-gray-700 font-medium mb-1">Severity:</label>
                    <select id="severity" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400">
                        <option value="">Select severity level</option>
                        <option value="Minor">Minor</option>
                        <option value="Medium">Medium</option>
                        <option value="Major">Major</option>
                    </select>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button type="submit" id="submitBtn" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Submit Report
                    </button>
                    <button type="button" onclick="showMainMenu()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Back to Menu
                    </button>
                </div>
            </form>
        </div>

        <!-- Admin Panel / Reports Display -->
        <div id="adminPanel" class="hidden transition-opacity duration-300">
            <h2 class="text-2xl sm:text-3xl font-semibold text-gray-800 mb-6 text-center">Reports</h2>
            <div id="reportsDisplay" class="h-96 overflow-y-auto space-y-4 p-4 rounded-lg bg-gray-100">
                <p class="text-gray-500 text-center">Loading reports...</p>
            </div>
            <div class="text-center mt-6">
                <button type="button" onclick="showMainMenu()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                    Back to Menu
                </button>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Alerts and Confirms -->
    <div id="customModal" class="hidden modal-overlay">
        <div class="modal">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            <div id="modalButtons" class="flex justify-center space-x-4">
                <button id="modalConfirmBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">Confirm</button>
                <button id="modalCancelBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // NOTE: This firebaseConfig is from your provided snippet.
        // The rest of the setup uses secure global variables.
        const firebaseConfig = {
            apiKey: "AIzaSyC--qumlfiy7QE48HTEAW3DyKlV7GLo-1E",
            authDomain: "fir-schoolfixed.firebaseapp.com",
            projectId: "fir-schoolfixed",
            storageBucket: "fir-schoolfixed.firebasestorage.app",
            messagingSenderId: "935512141284",
            appId: "1:935512141284:web:7259aa61ca91788738abf1"
        };
        
        let db, auth;
        let userId;

        // Secure Firebase Initialization with Custom Auth Token
        async function initFirebase() {
            try {
                // Initialize the Firebase app with the provided config
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Check for the custom auth token from the environment
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (token) {
                    // Sign in with the custom token for authenticated users
                    await signInWithCustomToken(auth, token);
                    console.log('Signed in with custom token.');
                } else {
                    // Sign in anonymously if no token is available
                    await signInAnonymously(auth);
                    console.log('Signed in anonymously.');
                }

                // Listen for auth state changes to get the user ID
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // Update connection status and start listening for reports
                        updateConnectionStatus(true);
                        setupReportListener();
                    } else {
                        console.error('Failed to authenticate.');
                        updateConnectionStatus(false, 'Disconnected');
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                updateConnectionStatus(false, 'Error');
            }
        }
        
        // Listen for real-time changes to the 'reports' collection
        function setupReportListener() {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }

            // The 'reports' collection will be public and shared among all users.
            const reportsCollectionRef = collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'reports');

            onSnapshot(reportsCollectionRef, (snapshot) => {
                const reports = [];
                snapshot.forEach(doc => {
                    reports.push({ ...doc.data(), id: doc.id });
                });
                console.log(`Received ${reports.length} reports in real-time.`);
                displayReports(reports);
            });
        }
        
        // UI Functions
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('reportForm').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function showReportForm() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('reportForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function showAdminPanel() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('reportForm').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        // Custom Modal UI instead of alert() and confirm()
        function showModal(title, message, isConfirm = false) {
            return new Promise(resolve => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMessage').textContent = message;
                
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const cancelBtn = document.getElementById('modalCancelBtn');
                
                if (isConfirm) {
                    confirmBtn.classList.remove('hidden');
                    cancelBtn.classList.remove('hidden');
                    confirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                    cancelBtn.onclick = () => { modal.classList.add('hidden'); resolve(false); };
                } else {
                    confirmBtn.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                    // Add a close button for simple alerts
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = 'Close';
                    closeBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200';
                    closeBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
                    document.getElementById('modalButtons').appendChild(closeBtn);
                }
                modal.classList.remove('hidden');
            });
        }

        // Spinner/Loading UI for buttons
        function showLoading(buttonId, text) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = true;
                button.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${text}`;
            }
        }

        function hideLoading(buttonId, text) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = false;
                button.innerHTML = text;
            }
        }

        async function submitReport(event) {
            event.preventDefault();
            if (!db) {
                showModal('Error', 'Database not connected. Please try again later.');
                return;
            }
            
            showLoading('submitBtn', 'Submitting...');
            
            const report = {
                Name: document.getElementById('name').value || 'Anonymous',
                Grade: document.getElementById('grade').value,
                Location: document.getElementById('location').value,
                'Issue Type': document.getElementById('issueType').value,
                Description: document.getElementById('description').value,
                Severity: document.getElementById('severity').value,
                Timestamp: serverTimestamp(),
                SubmittedBy: userId,
            };

            try {
                // Get a reference to the 'reports' collection
                const reportsCollectionRef = collection(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'reports');
                await addDoc(reportsCollectionRef, report);
                
                hideLoading('submitBtn', 'Submit Report');
                showModal('Success!', 'Your report has been submitted successfully.');
                document.getElementById('reportFormData').reset();
                showMainMenu();
            } catch (error) {
                hideLoading('submitBtn', 'Submit Report');
                console.error('Error submitting report:', error);
                showModal('Error', 'Failed to submit report. Please try again.');
            }
        }

        function displayReports(reports) {
            const reportsDisplay = document.getElementById('reportsDisplay');
            if (reports.length === 0) {
                reportsDisplay.innerHTML = '<p class="text-gray-500 text-center py-8">No reports found.</p>';
                return;
            }

            let html = '';
            reports.forEach(report => {
                const reportData = report;
                html += `
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <div class="text-sm font-medium text-gray-400 mb-2">
                            ${reportData.Timestamp ? new Date(reportData.Timestamp.seconds * 1000).toLocaleString() : 'Loading...'}
                        </div>
                        <h4 class="text-lg font-semibold text-gray-800">${reportData['Issue Type']} (${reportData.Severity})</h4>
                        <p class="text-gray-600 mt-2">${reportData.Description}</p>
                        <div class="mt-4 text-xs text-gray-500 space-y-1">
                            <p><strong>Location:</strong> ${reportData.Location}</p>
                            <p><strong>Grade:</strong> ${reportData.Grade}</p>
                            <p><strong>Submitted by:</strong> ${reportData.SubmittedBy}</p>
                        </div>
                        <div class="mt-4 text-right">
                            <button onclick="deleteReport('${report.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-2 px-3 rounded-lg transition-colors duration-200">
                                Resolve & Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            reportsDisplay.innerHTML = html;
        }

        async function deleteReport(reportId) {
            if (!db) {
                showModal('Error', 'Database not connected. Please try again later.');
                return;
            }

            const confirmed = await showModal('Confirm Deletion', 'Are you sure you want to delete this report? This cannot be undone.', true);
            
            if (confirmed) {
                try {
                    const docRef = doc(db, 'artifacts', typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', 'public', 'data', 'reports', reportId);
                    await deleteDoc(docRef);
                    showModal('Success!', 'Report has been deleted successfully.');
                } catch (error) {
                    console.error('Error deleting report:', error);
                    showModal('Error', 'Failed to delete report. Please try again.');
                }
            }
        }

        function updateConnectionStatus(isConnected, message = 'Connected') {
            const statusEl = document.getElementById('connectionStatus');
            if (isConnected) {
                statusEl.textContent = 'ðŸŸ¢ ' + message;
                statusEl.className = 'connection-status connected bg-emerald-100 text-emerald-800';
            } else {
                statusEl.textContent = 'ðŸ”´ ' + message;
                statusEl.className = 'connection-status disconnected bg-red-100 text-red-800';
            }
        }
        
        // Initialize the app on window load
        window.onload = initFirebase;
    </script>
</body>
</html>
